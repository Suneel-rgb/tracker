<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>School Contact Caller â€” Cards + Sorting + Export</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --bg-dark:#0f172a; --card-dark:#1e293b; --text-dark:#f1f5f9; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .dark-mode { background-color: var(--bg-dark); color: var(--text-dark); }
    .dark-mode .card { background-color: var(--card-dark); color: var(--text-dark); }
    .dark-mode .form-control, .dark-mode .form-select { background-color:#0b1223; color:var(--text-dark); border-color:#334155; }
    .dark-mode .form-control::placeholder { color:#94a3b8; }
    .pill { display:inline-block; padding:2px 8px; border-radius:20px; background:#e0f2fe; font-size:.8rem; font-weight:600; color:#0369a1; }
    .muted { color:#6b7280; }
    .fab-add { position:fixed; bottom:1.5rem; right:1.5rem; z-index:1050; border-radius:9999px; padding:.9rem 1rem; font-weight:700; }
    .empty-state { border:2px dashed #cbd5e1; border-radius:1rem; padding:2rem; text-align:center; color:#64748b; }
    .card-actions .btn { border-radius:9999px; }
    /* Dark mode polish */
    .dark-mode { transition: background-color .2s ease, color .2s ease; }
    .dark-mode .badge.date { background-color:#0b1223; color:#e2e8f0; border:1px solid #334155; }
    .dark-mode .text-body-secondary { color:#94a3b8 !important; }
    .dark-mode .pill { background:rgba(14,165,233,.15); color:#7dd3fc; border:1px solid #334155; }
    .dark-mode .empty-state { border-color:#334155; color:#94a3b8; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <h1 class="fw-bold m-0">ðŸ“˜</h1>
      <div class="vr"></div>
      <div>
        <div class="fw-semibold">Students</div>
        <small class="text-body-secondary">Quick caller & tracker</small>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <input id="search" class="form-control" style="max-width:280px" placeholder="Search by name or school" aria-label="Search students">
      <button id="themeToggle" class="btn btn-outline-secondary" type="button" aria-pressed="false" aria-label="Toggle theme">ðŸŒ—</button>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <span class="badge text-bg-primary" id="count">0</span>
      <span class="text-body-secondary ms-1">total</span>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <div class="input-group" style="max-width: 340px;">
        <label class="input-group-text" for="sortBy">Sort</label>
        <select id="sortBy" class="form-select">
          <option value="name" selected>Name</option>
          <option value="school">School</option>
          <option value="date">Date</option>
          <option value="payment">Payment</option>
        </select>
        <button id="sortDirBtn" class="btn btn-outline-secondary" type="button" title="Toggle sort direction" aria-label="Toggle sort direction">â†‘â†“</button>
      </div>
      <div class="btn-group" role="group" aria-label="Export and import">
        <button id="exportCSV" class="btn btn-outline-primary" type="button">Export CSV</button>
        <button id="exportJSON" class="btn btn-outline-primary" type="button">Export JSON</button>
        <button id="importBtn" class="btn btn-outline-secondary" type="button">Import</button>
        <input id="importFile" type="file" accept=".json,.csv" hidden>
      </div>
    </div>
  </div>

  <!-- Cards Grid -->
  <div id="cards" class="row g-3" aria-live="polite"></div>
</div>

<!-- Floating Add Button -->
<button class="btn btn-primary fab-add shadow" data-bs-toggle="offcanvas" data-bs-target="#studentPanel">âž• Add</button>

<!-- Add/Edit Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="studentPanel" aria-labelledby="studentPanelLabel" style="--bs-offcanvas-width: 420px;">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="studentPanelLabel">Add / Edit Student</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="student-form" class="row g-3" novalidate>
      <input type="hidden" id="editIndex"/>
      <div class="col-12">
        <label class="form-label" for="name">Student name</label>
        <input id="name" type="text" class="form-control" required />
      </div>
      <div class="col-12">
        <label class="form-label" for="school">School</label>
        <input id="school" type="text" class="form-control" required />
      </div>
      <div class="col-6">
        <label class="form-label" for="father">Father phone</label>
        <input id="father" type="tel" inputmode="tel" class="form-control" />
      </div>
      <div class="col-6">
        <label class="form-label" for="mother">Mother phone</label>
        <input id="mother" type="tel" inputmode="tel" class="form-control" />
      </div>
      <div class="col-6">
        <label class="form-label" for="date">Date</label>
        <input id="date" type="date" class="form-control" />
      </div>
      <div class="col-6">
        <label class="form-label" for="paidAmount">Paid amount</label>
        <input id="paidAmount" type="number" class="form-control" />
      </div>
      <div class="col-6">
        <label class="form-label" for="pendingAmount">Pending amount</label>
        <input id="pendingAmount" type="number" class="form-control" />
      </div>
      <div class="col-6">
        <label class="form-label" for="paidDate">Paid date</label>
        <input id="paidDate" type="date" class="form-control" />
      </div>
    </form>
    <div class="d-flex gap-2 mt-3">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
      <button type="button" class="btn btn-success" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<!-- Card Template -->
<template id="card-template">
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body d-flex flex-column">
        <div class="d-flex align-items-start justify-content-between mb-2">
          <div>
            <h5 class="card-title mb-1 name">â€”</h5>
            <div class="school"></div>
          </div>
          <span class="badge text-bg-light date align-self-start">â€”</span>
        </div>
        <div class="vstack gap-2 small mb-3">
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-body-secondary">Father</span>
            <div class="father">â€”</div>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-body-secondary">Mother</span>
            <div class="mother">â€”</div>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-body-secondary">Paid Amt</span>
            <div class="paidAmount fw-medium">â€”</div>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-body-secondary">Pending Amt</span>
            <div class="pendingAmount fw-medium">â€”</div>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-body-secondary">Paid Date</span>
            <div class="paidDate fw-medium">â€”</div>
          </div>
        </div>
        <div class="mt-auto d-flex gap-2 card-actions">
          <button class="btn btn-warning btn-sm edit flex-fill" type="button">Edit</button>
          <button class="btn btn-danger btn-sm delete flex-fill" type="button">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
const STORAGE_KEY = 'school-caller:v7:cards-no-paymentdetails';
let data = [];
const $ = (s, r=document) => r.querySelector(s);
const cardsWrap = $('#cards');
const tmpl = $('#card-template');
const countEl = $('#count');
let sortBy = 'name';
let sortDir = 'asc';

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function load(){ try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ data=[]; } }
function cleanNumber(raw){ if(!raw) return ''; raw=String(raw).trim(); const plus = raw.startsWith('+')?'+':''; const digits=raw.replace(/\D/g,''); return digits?plus+digits:''; }
function telLink(num){ const n=cleanNumber(num); return n?`tel:${n}`:''; }

function render(list=data){
  cardsWrap.innerHTML = '';
  if(!list.length){
    cardsWrap.innerHTML = `<div class=\"col-12\"><div class=\"empty-state\">
      <div class=\"fs-5\">No students yet</div>
      <div class=\"small\">Click <strong>âž• Add</strong> to create your first card.</div>
    </div></div>`;
    countEl.textContent='0';
    return;
  }
  list.forEach((row,i)=>{
    const node = tmpl.content.firstElementChild.cloneNode(true);
    $('.name',node).textContent = row.name;
    $('.school',node).innerHTML = `<span class=\"pill\">${row.school}</span>`;
    $('.paidAmount',node).textContent = row.paidAmount || 'â€”';
    $('.pendingAmount',node).textContent = row.pendingAmount || 'â€”';
    $('.paidDate',node).textContent = row.paidDate || 'â€”';
    $('.date',node).textContent = row.date || 'â€”';
    const father = cleanNumber(row.father);
    const mother = cleanNumber(row.mother);
    $('.father',node).innerHTML = father ? `<a href=\"${telLink(father)}\" class=\"btn btn-sm btn-outline-primary me-2\">Call</a> <span class=\"fw-medium\">${father}</span>` : '<span class=\"text-body-secondary\">â€”</span>';
    $('.mother',node).innerHTML = mother ? `<a href=\"${telLink(mother)}\" class=\"btn btn-sm btn-outline-primary me-2\">Call</a> <span class=\"fw-medium\">${mother}</span>` : '<span class=\"text-body-secondary\">â€”</span>';
    $('.edit',node).addEventListener('click',()=>startEdit(i));
    $('.delete',node).addEventListener('click',()=>removeAt(i));
    cardsWrap.appendChild(node);
  });
  countEl.textContent = list.length;
}

function upsert(row,index){ if(index!=='' && index!=null) data[index]=row; else data.push(row); save(); render(); }
function removeAt(i){ if(!confirm('Delete this student?')) return; data.splice(i,1); save(); render(); }
function startEdit(i){
  const r=data[i];
  $('#editIndex').value=i;
  $('#name').value=r.name; $('#school').value=r.school;
  $('#father').value=r.father||''; $('#mother').value=r.mother||'';
  $('#date').value=r.date||'';
  $('#paidAmount').value=r.paidAmount||''; $('#pendingAmount').value=r.pendingAmount||''; $('#paidDate').value=r.paidDate||'';
  bootstrap.Offcanvas.getOrCreateInstance($('#studentPanel')).show();
}
function clearForm(){ $('#editIndex').value=''; $('#student-form').reset(); }

$('#saveBtn').addEventListener('click',()=>{
  const row={ 
    name:$('#name').value.trim(),
    school:$('#school').value.trim(),
    father:cleanNumber($('#father').value),
    mother:cleanNumber($('#mother').value),
    date:$('#date').value,
    paidAmount:$('#paidAmount').value.trim(),
    pendingAmount:$('#pendingAmount').value.trim(),
    paidDate:$('#paidDate').value
  };
  if(!row.name||!row.school){ alert('Name and school required'); return; }
  const idx=$('#editIndex').value; upsert(row,idx);
  clearForm();
  bootstrap.Offcanvas.getOrCreateInstance($('#studentPanel')).hide();
});

$('#search').addEventListener('input',(e)=>{
  const q=e.target.value.toLowerCase().trim();
  const filtered = data.filter(r=> r.name.toLowerCase().includes(q)||r.school.toLowerCase().includes(q));
  render(filtered);
});

const THEME_KEY='ui-theme';
function applyTheme(mode){
  const dark = mode==='dark';
  document.body.classList.toggle('dark-mode', dark);
  document.documentElement.setAttribute('data-bs-theme', dark?'dark':'light');
  $('#themeToggle').setAttribute('aria-pressed', String(dark));
}
const detected = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
applyTheme(detected);
$('#themeToggle').addEventListener('click',()=>{
  const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
});

load(); render();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
